# 의존성(Dependency) 점진적 리팩토링 규칙

이 문서는 `server2` 프로젝트에서 의존성 주입(Dependency Injection)을 활용한 권한 확인 로직 및 공통 기능들을 리팩토링하고 관리하기 위한 규칙을 정의합니다.

## 규칙의 목표

-   도메인 간의 불필요한 결합도를 낮추고, 각 도메인의 독립성을 유지합니다.
-   공용으로 사용될 수 있는 기능들의 재사용성을 극대화합니다.
-   코드의 가독성 및 유지보수성을 향상시킵니다.
-   '거대 코어(God Core)' 문제 또는 특정 도메인의 비대화를 방지합니다.

## 점진적 리팩토링 규칙 (Progressive Refactoring Rule)

1.  **1단계 (도메인 내 구현):**
    -   새로운 기능을 구현하거나 기존 기능을 리팩토링할 때, **우선은 해당 기능이 속한 도메인 내에서 모든 로직(단위 검사기, 조합 의존성 등)을 작성하여 동작하게 만듭니다.**
    -   이 단계에서는 다른 도메인과의 공통성을 과도하게 예측하기보다, 해당 도메인의 요구사항을 충족하는 데 집중합니다.

2.  **2단계 (공통 부품 분석):**
    -   기능 구현이 완료된 후, 해당 도메인 내의 코드(특히 의존성 관련 로직)를 함께 검토하여, **다른 도메인에서도 재사용될 수 있는 '공통 부품'(단위 검사기 함수, 유틸리티 클래스 등)이 있는지 분석합니다.**
    -   예시: `is_device_owner`처럼 특정 리소스의 소유권을 확인하는 로직.

3.  **3단계 (중앙화 결정):**
    -   2단계에서 분석된 '공통 부품'이 **둘 이상의 도메인에서 필요하다고 판단될 경우**, 해당 부품들을 `app/core/authorization/` 또는 `app/core/dependencies/`와 같은 중앙의 **안정적이고 공용으로 관리되는 위치로 이동**시켜 재사용성을 극대화합니다.
    -   이때, 중앙 모듈은 명확한 인터페이스를 가지며, 내부 구현의 변경이 외부에 미치는 영향을 최소화하도록 설계합니다.

---

**적용 예시:**

`devices` 도메인의 권한 확인 로직을 리팩토링할 때, `device_dependencies.py` 내에서 `is_device_owner`와 `require_read_access`를 먼저 구현합니다. 이후 `schedules` 도메인에서도 기기 소유권 확인이 필요하다는 것이 명확해지면, `is_device_owner` 함수를 `app/core/authorization/checkers.py`와 같은 중앙 위치로 옮기고, `device_dependencies.py` 및 `schedule_dependencies.py`에서 이를 가져와 사용합니다.

"""refactor_system_unit_assignments

Revision ID: 191b9e3a7263
Revises: 011ddd7eaebf
Create Date: 2026-02-13 03:16:28.380153

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '191b9e3a7263'
down_revision: Union[str, Sequence[str], None] = '011ddd7eaebf'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('system_unit_assignments',
    sa.Column('id', sa.BigInteger(), nullable=False),
    sa.Column('system_unit_id', sa.BigInteger(), nullable=False),
    sa.Column('user_id', sa.BigInteger(), nullable=True),
    sa.Column('organization_id', sa.BigInteger(), nullable=True),
    sa.Column('role', sa.Enum('OWNER', 'OPERATOR', 'VIEWER', name='assignment_role_type'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('(user_id IS NOT NULL AND organization_id IS NULL) OR (user_id IS NULL AND organization_id IS NOT NULL)', name='check_exclusive_assignment_subject'),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], ),
    sa.ForeignKeyConstraint(['system_unit_id'], ['system_units.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_system_unit_assignments_created_at'), 'system_unit_assignments', ['created_at'], unique=False)
    op.create_index(op.f('ix_system_unit_assignments_id'), 'system_unit_assignments', ['id'], unique=False)
    op.create_index(op.f('ix_system_unit_assignments_organization_id'), 'system_unit_assignments', ['organization_id'], unique=False)
    op.create_index(op.f('ix_system_unit_assignments_system_unit_id'), 'system_unit_assignments', ['system_unit_id'], unique=False)
    op.create_index(op.f('ix_system_unit_assignments_user_id'), 'system_unit_assignments', ['user_id'], unique=False)
    op.create_index('ix_unique_unit_owner_constraint', 'system_unit_assignments', ['system_unit_id'], unique=True, postgresql_where=sa.text("role = 'OWNER'"))
    op.drop_index(op.f('ix_organization_devices_id'), table_name='organization_devices')
    op.drop_table('organization_devices')
    op.drop_index(op.f('ix_user_devices_id'), table_name='user_devices')
    op.drop_table('user_devices')
    op.create_index(op.f('ix_access_requests_created_at'), 'access_requests', ['created_at'], unique=False)
    op.add_column('action_logs', sa.Column('organization_id', sa.BigInteger(), nullable=True))
    op.create_index(op.f('ix_action_logs_created_at'), 'action_logs', ['created_at'], unique=False)
    op.create_index(op.f('ix_action_logs_device_id'), 'action_logs', ['device_id'], unique=False)
    op.create_index(op.f('ix_action_logs_organization_id'), 'action_logs', ['organization_id'], unique=False)
    op.create_foreign_key(None, 'action_logs', 'organizations', ['organization_id'], ['id'])
    op.create_index(op.f('ix_alert_events_created_at'), 'alert_events', ['created_at'], unique=False)
    op.create_index(op.f('ix_alert_events_device_id'), 'alert_events', ['device_id'], unique=False)
    op.add_column('alert_rules', sa.Column('organization_id', sa.BigInteger(), nullable=True))
    op.create_index(op.f('ix_alert_rules_created_at'), 'alert_rules', ['created_at'], unique=False)
    op.create_index(op.f('ix_alert_rules_organization_id'), 'alert_rules', ['organization_id'], unique=False)
    op.create_index(op.f('ix_alert_rules_user_id'), 'alert_rules', ['user_id'], unique=False)
    op.create_foreign_key(None, 'alert_rules', 'organizations', ['organization_id'], ['id'])
    op.create_index(op.f('ix_audit_log_details_created_at'), 'audit_log_details', ['created_at'], unique=False)
    op.add_column('audit_logs', sa.Column('organization_id', sa.BigInteger(), nullable=True))
    op.create_index(op.f('ix_audit_logs_created_at'), 'audit_logs', ['created_at'], unique=False)
    op.create_index(op.f('ix_audit_logs_log_level'), 'audit_logs', ['log_level'], unique=False)
    op.create_index(op.f('ix_audit_logs_organization_id'), 'audit_logs', ['organization_id'], unique=False)
    op.create_foreign_key(None, 'audit_logs', 'organizations', ['organization_id'], ['id'])
    op.create_index(op.f('ix_batch_trackings_created_at'), 'batch_trackings', ['created_at'], unique=False)
    op.create_index(op.f('ix_batch_trackings_device_id'), 'batch_trackings', ['device_id'], unique=False)
    op.create_index(op.f('ix_blueprint_pin_details_created_at'), 'blueprint_pin_details', ['created_at'], unique=False)
    op.create_index(op.f('ix_blueprint_pin_mappings_created_at'), 'blueprint_pin_mappings', ['created_at'], unique=False)
    op.create_index(op.f('ix_blueprint_pin_mappings_hardware_blueprint_id'), 'blueprint_pin_mappings', ['hardware_blueprint_id'], unique=False)
    op.create_index(op.f('ix_blueprint_valid_pins_created_at'), 'blueprint_valid_pins', ['created_at'], unique=False)
    op.create_index(op.f('ix_blueprint_valid_pins_hardware_blueprint_id'), 'blueprint_valid_pins', ['hardware_blueprint_id'], unique=False)
    op.add_column('consumable_usage_logs', sa.Column('organization_id', sa.BigInteger(), nullable=True))
    op.create_index(op.f('ix_consumable_usage_logs_created_at'), 'consumable_usage_logs', ['created_at'], unique=False)
    op.create_index(op.f('ix_consumable_usage_logs_device_id'), 'consumable_usage_logs', ['device_id'], unique=False)
    op.create_index(op.f('ix_consumable_usage_logs_log_level'), 'consumable_usage_logs', ['log_level'], unique=False)
    op.create_index(op.f('ix_consumable_usage_logs_organization_id'), 'consumable_usage_logs', ['organization_id'], unique=False)
    op.create_index(op.f('ix_consumable_usage_logs_user_id'), 'consumable_usage_logs', ['user_id'], unique=False)
    op.create_foreign_key(None, 'consumable_usage_logs', 'organizations', ['organization_id'], ['id'])
    op.drop_index(op.f('ix_unique_spatial_slot'), table_name='device_component_instances')
    op.create_index('ix_unique_spatial_slot', 'device_component_instances', [sa.literal_column("((spatial_context->'grid'->>'row')), ((spatial_context->'grid'->>'col')), ((spatial_context->'grid'->>'layer'))")], unique=True)
    op.create_index(op.f('ix_device_component_instances_created_at'), 'device_component_instances', ['created_at'], unique=False)
    op.create_index(op.f('ix_device_component_instances_device_id'), 'device_component_instances', ['device_id'], unique=False)
    op.create_index(op.f('ix_device_component_pin_mappings_created_at'), 'device_component_pin_mappings', ['created_at'], unique=False)
    op.create_index(op.f('ix_device_component_pin_mappings_device_id'), 'device_component_pin_mappings', ['device_id'], unique=False)
    op.drop_constraint(op.f('fk_device_component_pin_mappings_device_id_devices'), 'device_component_pin_mappings', type_='foreignkey')
    op.create_index(op.f('ix_device_logs_created_at'), 'device_logs', ['created_at'], unique=False)
    op.create_index(op.f('ix_device_logs_device_id'), 'device_logs', ['device_id'], unique=False)
    op.create_index(op.f('ix_device_logs_log_level'), 'device_logs', ['log_level'], unique=False)
    op.create_index(op.f('ix_device_role_assignments_created_at'), 'device_role_assignments', ['created_at'], unique=False)
    op.create_index(op.f('ix_device_role_assignments_device_id'), 'device_role_assignments', ['device_id'], unique=False)
    op.create_index(op.f('ix_device_roles_created_at'), 'device_roles', ['created_at'], unique=False)
    op.add_column('devices', sa.Column('owner_user_id', sa.BigInteger(), nullable=True))
    op.add_column('devices', sa.Column('owner_organization_id', sa.BigInteger(), nullable=True))
    op.create_index(op.f('ix_devices_created_at'), 'devices', ['created_at'], unique=False)
    op.create_index(op.f('ix_devices_hardware_blueprint_id'), 'devices', ['hardware_blueprint_id'], unique=False)
    op.create_index(op.f('ix_devices_owner_organization_id'), 'devices', ['owner_organization_id'], unique=False)
    op.create_index(op.f('ix_devices_owner_user_id'), 'devices', ['owner_user_id'], unique=False)
    op.create_foreign_key(None, 'devices', 'users', ['owner_user_id'], ['id'])
    op.create_foreign_key(None, 'devices', 'organizations', ['owner_organization_id'], ['id'])
    op.add_column('firmware_updates', sa.Column('initiated_by_organization_id', sa.BigInteger(), nullable=True))
    op.create_index(op.f('ix_firmware_updates_created_at'), 'firmware_updates', ['created_at'], unique=False)
    op.create_index(op.f('ix_firmware_updates_device_id'), 'firmware_updates', ['device_id'], unique=False)
    op.create_index(op.f('ix_firmware_updates_hardware_blueprint_id'), 'firmware_updates', ['hardware_blueprint_id'], unique=False)
    op.create_foreign_key(None, 'firmware_updates', 'organizations', ['initiated_by_organization_id'], ['id'])
    op.create_index(op.f('ix_governance_rules_created_at'), 'governance_rules', ['created_at'], unique=False)
    op.create_index(op.f('ix_hardware_blueprints_created_at'), 'hardware_blueprints', ['created_at'], unique=False)
    op.create_index(op.f('ix_image_registries_created_at'), 'image_registries', ['created_at'], unique=False)
    op.create_index(op.f('ix_image_registries_device_id'), 'image_registries', ['device_id'], unique=False)
    op.create_index(op.f('ix_internal_asset_definitions_created_at'), 'internal_asset_definitions', ['created_at'], unique=False)
    op.add_column('internal_asset_inventory', sa.Column('serial_number', sa.String(length=100), nullable=True))
    op.add_column('internal_asset_inventory', sa.Column('recorded_by_user_id', sa.BigInteger(), nullable=True))
    op.add_column('internal_asset_inventory', sa.Column('recorded_by_organization_id', sa.BigInteger(), nullable=True))
    op.drop_constraint(op.f('_asset_location_uc'), 'internal_asset_inventory', type_='unique')
    op.create_index(op.f('ix_internal_asset_inventory_created_at'), 'internal_asset_inventory', ['created_at'], unique=False)
    op.create_index(op.f('ix_internal_asset_inventory_recorded_by_organization_id'), 'internal_asset_inventory', ['recorded_by_organization_id'], unique=False)
    op.create_index(op.f('ix_internal_asset_inventory_recorded_by_user_id'), 'internal_asset_inventory', ['recorded_by_user_id'], unique=False)
    op.create_index(op.f('ix_internal_asset_inventory_serial_number'), 'internal_asset_inventory', ['serial_number'], unique=False)
    op.create_unique_constraint('uq_asset_inventory_org', 'internal_asset_inventory', ['asset_definition_id', 'location', 'recorded_by_organization_id', 'serial_number'])
    op.create_unique_constraint('uq_asset_inventory_user', 'internal_asset_inventory', ['asset_definition_id', 'location', 'recorded_by_user_id', 'serial_number'])
    op.create_foreign_key(None, 'internal_asset_inventory', 'organizations', ['recorded_by_organization_id'], ['id'])
    op.create_foreign_key(None, 'internal_asset_inventory', 'users', ['recorded_by_user_id'], ['id'])
    op.add_column('internal_asset_purchase_records', sa.Column('recorded_by_organization_id', sa.BigInteger(), nullable=True))
    op.create_index(op.f('ix_internal_asset_purchase_records_created_at'), 'internal_asset_purchase_records', ['created_at'], unique=False)
    op.create_index(op.f('ix_internal_asset_purchase_records_recorded_by_organization_id'), 'internal_asset_purchase_records', ['recorded_by_organization_id'], unique=False)
    op.create_foreign_key(None, 'internal_asset_purchase_records', 'organizations', ['recorded_by_organization_id'], ['id'])
    op.create_index(op.f('ix_internal_blueprint_components_created_at'), 'internal_blueprint_components', ['created_at'], unique=False)
    op.create_index(op.f('ix_internal_blueprint_components_hardware_blueprint_id'), 'internal_blueprint_components', ['hardware_blueprint_id'], unique=False)
    op.create_index(op.f('ix_internal_system_unit_physical_components_created_at'), 'internal_system_unit_physical_components', ['created_at'], unique=False)
    op.create_index(op.f('ix_observation_snapshots_created_at'), 'observation_snapshots', ['created_at'], unique=False)
    op.create_index(op.f('ix_organization_subscriptions_created_at'), 'organization_subscriptions', ['created_at'], unique=False)
    op.create_index(op.f('ix_organization_subscriptions_organization_id'), 'organization_subscriptions', ['organization_id'], unique=False)
    op.create_index(op.f('ix_organization_types_created_at'), 'organization_types', ['created_at'], unique=False)
    op.alter_column('organizations', 'currency',
               existing_type=postgresql.ENUM('KRW', 'USD', name='currency_type'),
               type_=postgresql.ENUM('KRW', 'USD', name='currency_type'), # 명칭 유지
               existing_nullable=True)
    op.create_index(op.f('ix_organizations_created_at'), 'organizations', ['created_at'], unique=False)
    op.create_index(op.f('ix_permissions_created_at'), 'permissions', ['created_at'], unique=False)
    op.create_index(op.f('ix_plan_applicable_product_lines_created_at'), 'plan_applicable_product_lines', ['created_at'], unique=False)
    op.create_index(op.f('ix_product_lines_created_at'), 'product_lines', ['created_at'], unique=False)
    op.add_column('provisioning_tokens', sa.Column('issued_by_organization_id', sa.BigInteger(), nullable=True))
    op.add_column('provisioning_tokens', sa.Column('system_unit_id', sa.BigInteger(), nullable=False))
    op.create_index(op.f('ix_provisioning_tokens_created_at'), 'provisioning_tokens', ['created_at'], unique=False)
    op.create_index(op.f('ix_provisioning_tokens_system_unit_id'), 'provisioning_tokens', ['system_unit_id'], unique=False)
    op.create_foreign_key(None, 'provisioning_tokens', 'system_units', ['system_unit_id'], ['id'])
    op.create_foreign_key(None, 'provisioning_tokens', 'organizations', ['issued_by_organization_id'], ['id'])
    op.create_index(op.f('ix_refresh_tokens_created_at'), 'refresh_tokens', ['created_at'], unique=False)
    op.create_index(op.f('ix_role_permissions_created_at'), 'role_permissions', ['created_at'], unique=False)
    op.create_index(op.f('ix_roles_created_at'), 'roles', ['created_at'], unique=False)
    op.create_index(op.f('ix_roles_organization_id'), 'roles', ['organization_id'], unique=False)
    op.add_column('schedules', sa.Column('organization_id', sa.BigInteger(), nullable=True))
    op.create_index(op.f('ix_schedules_created_at'), 'schedules', ['created_at'], unique=False)
    op.create_index(op.f('ix_schedules_organization_id'), 'schedules', ['organization_id'], unique=False)
    op.create_index(op.f('ix_schedules_user_id'), 'schedules', ['user_id'], unique=False)
    op.create_foreign_key(None, 'schedules', 'organizations', ['organization_id'], ['id'])
    op.create_index(op.f('ix_subscription_plan_features_created_at'), 'subscription_plan_features', ['created_at'], unique=False)
    op.create_index(op.f('ix_subscription_plans_created_at'), 'subscription_plans', ['created_at'], unique=False)
    op.create_index(op.f('ix_supported_component_metadata_created_at'), 'supported_component_metadata', ['created_at'], unique=False)
    op.create_index(op.f('ix_supported_components_created_at'), 'supported_components', ['created_at'], unique=False)
    op.drop_index(op.f('ix_system_units_user_id'), table_name='system_units')
    op.create_index(op.f('ix_system_units_created_at'), 'system_units', ['created_at'], unique=False)
    op.drop_constraint(op.f('system_units_user_id_fkey'), 'system_units', type_='foreignkey')
    op.drop_constraint(op.f('system_units_organization_id_fkey'), 'system_units', type_='foreignkey')
    op.drop_column('system_units', 'user_id')
    op.drop_column('system_units', 'organization_id')
    op.create_index(op.f('ix_telemetry_data_created_at'), 'telemetry_data', ['created_at'], unique=False)
    op.create_index(op.f('ix_telemetry_data_device_id'), 'telemetry_data', ['device_id'], unique=False)
    op.create_index(op.f('ix_telemetry_metadata_created_at'), 'telemetry_metadata', ['created_at'], unique=False)
    op.add_column('trigger_rules', sa.Column('organization_id', sa.BigInteger(), nullable=True))
    op.create_index(op.f('ix_trigger_rules_created_at'), 'trigger_rules', ['created_at'], unique=False)
    op.create_index(op.f('ix_trigger_rules_organization_id'), 'trigger_rules', ['organization_id'], unique=False)
    op.create_index(op.f('ix_trigger_rules_user_id'), 'trigger_rules', ['user_id'], unique=False)
    op.create_foreign_key(None, 'trigger_rules', 'organizations', ['organization_id'], ['id'])
    op.create_index(op.f('ix_unit_activity_logs_created_at'), 'unit_activity_logs', ['created_at'], unique=False)
    op.create_index(op.f('ix_unit_activity_logs_device_id'), 'unit_activity_logs', ['device_id'], unique=False)
    op.create_index(op.f('ix_unit_activity_logs_user_id'), 'unit_activity_logs', ['user_id'], unique=False)
    op.create_index(op.f('ix_user_consumables_created_at'), 'user_consumables', ['created_at'], unique=False)
    op.create_index(op.f('ix_user_consumables_user_id'), 'user_consumables', ['user_id'], unique=False)
    op.create_index(op.f('ix_user_organization_roles_created_at'), 'user_organization_roles', ['created_at'], unique=False)
    op.create_index(op.f('ix_user_organization_roles_organization_id'), 'user_organization_roles', ['organization_id'], unique=False)
    op.create_index(op.f('ix_user_organization_roles_user_id'), 'user_organization_roles', ['user_id'], unique=False)
    op.create_index(op.f('ix_user_subscriptions_created_at'), 'user_subscriptions', ['created_at'], unique=False)
    op.create_index(op.f('ix_user_subscriptions_user_id'), 'user_subscriptions', ['user_id'], unique=False)
    op.create_index(op.f('ix_users_created_at'), 'users', ['created_at'], unique=False)
    op.create_index(op.f('ix_vision_features_created_at'), 'vision_features', ['created_at'], unique=False)
    op.create_index(op.f('ix_vision_features_device_id'), 'vision_features', ['device_id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_vision_features_device_id'), table_name='vision_features')
    op.drop_index(op.f('ix_vision_features_created_at'), table_name='vision_features')
    op.drop_index(op.f('ix_users_created_at'), table_name='users')
    op.drop_index(op.f('ix_user_subscriptions_user_id'), table_name='user_subscriptions')
    op.drop_index(op.f('ix_user_subscriptions_created_at'), table_name='user_subscriptions')
    op.drop_index(op.f('ix_user_organization_roles_user_id'), table_name='user_organization_roles')
    op.drop_index(op.f('ix_user_organization_roles_organization_id'), table_name='user_organization_roles')
    op.drop_index(op.f('ix_user_organization_roles_created_at'), table_name='user_organization_roles')
    op.drop_index(op.f('ix_user_consumables_user_id'), table_name='user_consumables')
    op.drop_index(op.f('ix_user_consumables_created_at'), table_name='user_consumables')
    op.drop_index(op.f('ix_unit_activity_logs_user_id'), table_name='unit_activity_logs')
    op.drop_index(op.f('ix_unit_activity_logs_device_id'), table_name='unit_activity_logs')
    op.drop_index(op.f('ix_unit_activity_logs_created_at'), table_name='unit_activity_logs')
    op.drop_constraint(None, 'trigger_rules', type_='foreignkey')
    op.drop_index(op.f('ix_trigger_rules_user_id'), table_name='trigger_rules')
    op.drop_index(op.f('ix_trigger_rules_organization_id'), table_name='trigger_rules')
    op.drop_index(op.f('ix_trigger_rules_created_at'), table_name='trigger_rules')
    op.drop_column('trigger_rules', 'organization_id')
    op.drop_index(op.f('ix_telemetry_metadata_created_at'), table_name='telemetry_metadata')
    op.drop_index(op.f('ix_telemetry_data_device_id'), table_name='telemetry_data')
    op.drop_index(op.f('ix_telemetry_data_created_at'), table_name='telemetry_data')
    op.add_column('system_units', sa.Column('organization_id', sa.BIGINT(), autoincrement=False, nullable=True))
    op.add_column('system_units', sa.Column('user_id', sa.BIGINT(), autoincrement=False, nullable=True))
    op.create_foreign_key(op.f('system_units_organization_id_fkey'), 'system_units', 'organizations', ['organization_id'], ['id'])
    op.create_foreign_key(op.f('system_units_user_id_fkey'), 'system_units', 'users', ['user_id'], ['id'])
    op.drop_index(op.f('ix_system_units_created_at'), table_name='system_units')
    op.create_index(op.f('ix_system_units_user_id'), 'system_units', ['user_id'], unique=False)
    op.drop_index(op.f('ix_supported_components_created_at'), table_name='supported_components')
    op.drop_index(op.f('ix_supported_component_metadata_created_at'), table_name='supported_component_metadata')
    op.drop_index(op.f('ix_subscription_plans_created_at'), table_name='subscription_plans')
    op.drop_index(op.f('ix_subscription_plan_features_created_at'), table_name='subscription_plan_features')
    op.drop_constraint(None, 'schedules', type_='foreignkey')
    op.drop_index(op.f('ix_schedules_user_id'), table_name='schedules')
    op.drop_index(op.f('ix_schedules_organization_id'), table_name='schedules')
    op.drop_index(op.f('ix_schedules_created_at'), table_name='schedules')
    op.drop_column('schedules', 'organization_id')
    op.drop_index(op.f('ix_roles_organization_id'), table_name='roles')
    op.drop_index(op.f('ix_roles_created_at'), table_name='roles')
    op.drop_index(op.f('ix_role_permissions_created_at'), table_name='role_permissions')
    op.drop_index(op.f('ix_refresh_tokens_created_at'), table_name='refresh_tokens')
    op.drop_constraint(None, 'provisioning_tokens', type_='foreignkey')
    op.drop_constraint(None, 'provisioning_tokens', type_='foreignkey')
    op.drop_index(op.f('ix_provisioning_tokens_system_unit_id'), table_name='provisioning_tokens')
    op.drop_index(op.f('ix_provisioning_tokens_created_at'), table_name='provisioning_tokens')
    op.drop_column('provisioning_tokens', 'system_unit_id')
    op.drop_column('provisioning_tokens', 'issued_by_organization_id')
    op.drop_index(op.f('ix_product_lines_created_at'), table_name='product_lines')
    op.drop_index(op.f('ix_plan_applicable_product_lines_created_at'), table_name='plan_applicable_product_lines')
    op.drop_index(op.f('ix_permissions_created_at'), table_name='permissions')
    op.drop_index(op.f('ix_organizations_created_at'), table_name='organizations')
    op.alter_column('organizations', 'currency',
               existing_type=sa.Enum('KRW', 'USD', name='currencytype'),
               type_=postgresql.ENUM('KRW', 'USD', name='currency_type'),
               existing_nullable=True)
    op.drop_index(op.f('ix_organization_types_created_at'), table_name='organization_types')
    op.drop_index(op.f('ix_organization_subscriptions_organization_id'), table_name='organization_subscriptions')
    op.drop_index(op.f('ix_organization_subscriptions_created_at'), table_name='organization_subscriptions')
    op.drop_index(op.f('ix_observation_snapshots_created_at'), table_name='observation_snapshots')
    op.drop_index(op.f('ix_internal_system_unit_physical_components_created_at'), table_name='internal_system_unit_physical_components')
    op.drop_index(op.f('ix_internal_blueprint_components_hardware_blueprint_id'), table_name='internal_blueprint_components')
    op.drop_index(op.f('ix_internal_blueprint_components_created_at'), table_name='internal_blueprint_components')
    op.drop_constraint(None, 'internal_asset_purchase_records', type_='foreignkey')
    op.drop_index(op.f('ix_internal_asset_purchase_records_recorded_by_organization_id'), table_name='internal_asset_purchase_records')
    op.drop_index(op.f('ix_internal_asset_purchase_records_created_at'), table_name='internal_asset_purchase_records')
    op.drop_column('internal_asset_purchase_records', 'recorded_by_organization_id')
    op.drop_constraint(None, 'internal_asset_inventory', type_='foreignkey')
    op.drop_constraint(None, 'internal_asset_inventory', type_='foreignkey')
    op.drop_constraint('uq_asset_inventory_user', 'internal_asset_inventory', type_='unique')
    op.drop_constraint('uq_asset_inventory_org', 'internal_asset_inventory', type_='unique')
    op.drop_index(op.f('ix_internal_asset_inventory_serial_number'), table_name='internal_asset_inventory')
    op.drop_index(op.f('ix_internal_asset_inventory_recorded_by_user_id'), table_name='internal_asset_inventory')
    op.drop_index(op.f('ix_internal_asset_inventory_recorded_by_organization_id'), table_name='internal_asset_inventory')
    op.drop_index(op.f('ix_internal_asset_inventory_created_at'), table_name='internal_asset_inventory')
    op.create_unique_constraint(op.f('_asset_location_uc'), 'internal_asset_inventory', ['asset_definition_id', 'location'], postgresql_nulls_not_distinct=False)
    op.drop_column('internal_asset_inventory', 'recorded_by_organization_id')
    op.drop_column('internal_asset_inventory', 'recorded_by_user_id')
    op.drop_column('internal_asset_inventory', 'serial_number')
    op.drop_index(op.f('ix_internal_asset_definitions_created_at'), table_name='internal_asset_definitions')
    op.drop_index(op.f('ix_image_registries_device_id'), table_name='image_registries')
    op.drop_index(op.f('ix_image_registries_created_at'), table_name='image_registries')
    op.drop_index(op.f('ix_hardware_blueprints_created_at'), table_name='hardware_blueprints')
    op.drop_index(op.f('ix_governance_rules_created_at'), table_name='governance_rules')
    op.drop_constraint(None, 'firmware_updates', type_='foreignkey')
    op.drop_index(op.f('ix_firmware_updates_hardware_blueprint_id'), table_name='firmware_updates')
    op.drop_index(op.f('ix_firmware_updates_device_id'), table_name='firmware_updates')
    op.drop_index(op.f('ix_firmware_updates_created_at'), table_name='firmware_updates')
    op.drop_column('firmware_updates', 'initiated_by_organization_id')
    op.drop_constraint(None, 'devices', type_='foreignkey')
    op.drop_constraint(None, 'devices', type_='foreignkey')
    op.drop_index(op.f('ix_devices_owner_user_id'), table_name='devices')
    op.drop_index(op.f('ix_devices_owner_organization_id'), table_name='devices')
    op.drop_index(op.f('ix_devices_hardware_blueprint_id'), table_name='devices')
    op.drop_index(op.f('ix_devices_created_at'), table_name='devices')
    op.drop_column('devices', 'owner_organization_id')
    op.drop_column('devices', 'owner_user_id')
    op.drop_index(op.f('ix_device_roles_created_at'), table_name='device_roles')
    op.drop_index(op.f('ix_device_role_assignments_device_id'), table_name='device_role_assignments')
    op.drop_index(op.f('ix_device_role_assignments_created_at'), table_name='device_role_assignments')
    op.drop_index(op.f('ix_device_logs_log_level'), table_name='device_logs')
    op.drop_index(op.f('ix_device_logs_device_id'), table_name='device_logs')
    op.drop_index(op.f('ix_device_logs_created_at'), table_name='device_logs')
    op.create_foreign_key(op.f('fk_device_component_pin_mappings_device_id_devices'), 'device_component_pin_mappings', 'devices', ['device_id'], ['id'], ondelete='CASCADE')
    op.drop_index(op.f('ix_device_component_pin_mappings_device_id'), table_name='device_component_pin_mappings')
    op.drop_index(op.f('ix_device_component_pin_mappings_created_at'), table_name='device_component_pin_mappings')
    op.drop_index(op.f('ix_device_component_instances_device_id'), table_name='device_component_instances')
    op.drop_index(op.f('ix_device_component_instances_created_at'), table_name='device_component_instances')
    op.drop_index('ix_unique_spatial_slot', table_name='device_component_instances')
    op.create_index(op.f('ix_unique_spatial_slot'), 'device_component_instances', [sa.literal_column("((spatial_context -> 'grid'::text) ->> 'row'::text)"), sa.literal_column("((spatial_context -> 'grid'::text) ->> 'col'::text)"), sa.literal_column("((spatial_context -> 'grid'::text) ->> 'layer'::text)")], unique=True)
    op.drop_constraint(None, 'consumable_usage_logs', type_='foreignkey')
    op.drop_index(op.f('ix_consumable_usage_logs_user_id'), table_name='consumable_usage_logs')
    op.drop_index(op.f('ix_consumable_usage_logs_organization_id'), table_name='consumable_usage_logs')
    op.drop_index(op.f('ix_consumable_usage_logs_log_level'), table_name='consumable_usage_logs')
    op.drop_index(op.f('ix_consumable_usage_logs_device_id'), table_name='consumable_usage_logs')
    op.drop_index(op.f('ix_consumable_usage_logs_created_at'), table_name='consumable_usage_logs')
    op.drop_column('consumable_usage_logs', 'organization_id')
    op.drop_index(op.f('ix_blueprint_valid_pins_hardware_blueprint_id'), table_name='blueprint_valid_pins')
    op.drop_index(op.f('ix_blueprint_valid_pins_created_at'), table_name='blueprint_valid_pins')
    op.drop_index(op.f('ix_blueprint_pin_mappings_hardware_blueprint_id'), table_name='blueprint_pin_mappings')
    op.drop_index(op.f('ix_blueprint_pin_mappings_created_at'), table_name='blueprint_pin_mappings')
    op.drop_index(op.f('ix_blueprint_pin_details_created_at'), table_name='blueprint_pin_details')
    op.drop_index(op.f('ix_batch_trackings_device_id'), table_name='batch_trackings')
    op.drop_index(op.f('ix_batch_trackings_created_at'), table_name='batch_trackings')
    op.drop_constraint(None, 'audit_logs', type_='foreignkey')
    op.drop_index(op.f('ix_audit_logs_organization_id'), table_name='audit_logs')
    op.drop_index(op.f('ix_audit_logs_log_level'), table_name='audit_logs')
    op.drop_index(op.f('ix_audit_logs_created_at'), table_name='audit_logs')
    op.drop_column('audit_logs', 'organization_id')
    op.drop_index(op.f('ix_audit_log_details_created_at'), table_name='audit_log_details')
    op.drop_constraint(None, 'alert_rules', type_='foreignkey')
    op.drop_index(op.f('ix_alert_rules_user_id'), table_name='alert_rules')
    op.drop_index(op.f('ix_alert_rules_organization_id'), table_name='alert_rules')
    op.drop_index(op.f('ix_alert_rules_created_at'), table_name='alert_rules')
    op.drop_column('alert_rules', 'organization_id')
    op.drop_index(op.f('ix_alert_events_device_id'), table_name='alert_events')
    op.drop_index(op.f('ix_alert_events_created_at'), table_name='alert_events')
    op.drop_constraint(None, 'action_logs', type_='foreignkey')
    op.drop_index(op.f('ix_action_logs_organization_id'), table_name='action_logs')
    op.drop_index(op.f('ix_action_logs_device_id'), table_name='action_logs')
    op.drop_index(op.f('ix_action_logs_created_at'), table_name='action_logs')
    op.drop_column('action_logs', 'organization_id')
    op.drop_index(op.f('ix_access_requests_created_at'), table_name='access_requests')
    op.create_table('user_devices',
    sa.Column('id', sa.BIGINT(), autoincrement=True, nullable=False),
    sa.Column('role', sa.VARCHAR(length=20), autoincrement=False, nullable=False),
    sa.Column('nickname', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.BIGINT(), autoincrement=False, nullable=False),
    sa.Column('device_id', sa.BIGINT(), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['device_id'], ['devices.id'], name=op.f('user_devices_device_id_fkey')),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('user_devices_user_id_fkey')),
    sa.PrimaryKeyConstraint('id', name=op.f('user_devices_pkey')),
    sa.UniqueConstraint('user_id', 'device_id', name=op.f('_user_device_uc'), postgresql_include=[], postgresql_nulls_not_distinct=False)
    )
    op.create_index(op.f('ix_user_devices_id'), 'user_devices', ['id'], unique=False)
    op.create_table('organization_devices',
    sa.Column('id', sa.BIGINT(), autoincrement=True, nullable=False),
    sa.Column('organization_id', sa.BIGINT(), autoincrement=False, nullable=False),
    sa.Column('device_id', sa.BIGINT(), autoincrement=False, nullable=False),
    sa.Column('relationship_type', postgresql.ENUM('OWNER', 'OPERATOR', 'VIEWER', name='org_device_relationship_type'), autoincrement=False, nullable=False),
    sa.Column('is_active', sa.BOOLEAN(), autoincrement=False, nullable=False),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['device_id'], ['devices.id'], name=op.f('organization_devices_device_id_fkey')),
    sa.ForeignKeyConstraint(['organization_id'], ['organizations.id'], name=op.f('organization_devices_organization_id_fkey')),
    sa.PrimaryKeyConstraint('id', name=op.f('organization_devices_pkey')),
    sa.UniqueConstraint('organization_id', 'device_id', 'relationship_type', name=op.f('_organization_device_uc'), postgresql_include=[], postgresql_nulls_not_distinct=False)
    )
    op.create_index(op.f('ix_organization_devices_id'), 'organization_devices', ['id'], unique=False)
    op.drop_index('ix_unique_unit_owner_constraint', table_name='system_unit_assignments', postgresql_where=sa.text("role = 'OWNER'"))
    op.drop_index(op.f('ix_system_unit_assignments_user_id'), table_name='system_unit_assignments')
    op.drop_index(op.f('ix_system_unit_assignments_system_unit_id'), table_name='system_unit_assignments')
    op.drop_index(op.f('ix_system_unit_assignments_organization_id'), table_name='system_unit_assignments')
    op.drop_index(op.f('ix_system_unit_assignments_id'), table_name='system_unit_assignments')
    op.drop_index(op.f('ix_system_unit_assignments_created_at'), table_name='system_unit_assignments')
    op.drop_table('system_unit_assignments')
    # ### end Alembic commands ###

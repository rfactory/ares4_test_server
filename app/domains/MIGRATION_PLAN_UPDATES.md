# Server2 마이그레이션 계획 보충 및 누락 기능 정의 (v2)

이 문서는 기존 `MIGRATION_PLAN.md`에 명시되지 않았거나, `server` 코드베이스 분석 결과 `server2`에서 미구현 상태로 확인된 주요 기능 및 도메인에 대한 마이그레이션 및 구현 계획을 보충합니다. `server2`의 온톨로지화된 아키텍처 원칙에 따라, 새로 개발되거나 완성될 모든 기능은 이 원칙을 준수해야 합니다.

`server2/app/models` 디렉토리 분석 결과, 일부 기능들은 모델이 이미 존재하는 것으로 확인되어 '완전 신규 개발'에서 '기존 구조 완성'으로 재분류합니다.

---

## 1. 완전 신규 개발이 필요한 기능

(`server2`에 아직 관련 모델이나 API가 없어, 주로 기존 도메인 내에 새로운 API 엔드포인트 구현이 필요한 기능들)

### 1.1. 추가 인증 및 사용자 관리 API 구현
-   **목표:** `server`에 존재했으나 `server2`에 아직 없는 사용자 편의 및 관리 관련 인증/사용자 API를 구현합니다.
-   **세부 고려사항:**
    -   `accounts` 도메인 내에 이메일 토큰을 검증하는 `POST /verify-email` API를 구현합니다.
    -   인증 이메일 재전송을 위한 `POST /resend_verification_email` API를 구현합니다。
    -   사용자가 관리자 역할을 요청할 수 있는 `POST /request-upgrade` API를 구현합니다.
    -   사용자가 자신의 비밀번호를 변경할 수 있는 `PUT /users/me/password` API를 구현합니다.

---

## 2. 기존 구조 완성이 필요한 기능

(`server2`에 이미 모델(테이블)이 존재하므로, 이를 기반으로 서비스 및 API 계층을 구현해야 하는 기능들)

### 2.1. 감사 로그 (`Audit`) 도메인 완성
-   **목표:** 시스템의 주요 이벤트를 기록하여 보안 및 안정성을 강화합니다.
-   **세부 고려사항:**
    -   `server2`에 이미 존재하는 `AuditLog` 및 `AuditLogDetail` 모델을 기반으로 합니다.
    -   **기록 정책 수립:** 모든 데이터 **생성/수정/삭제(C/U/D)** 액션을 필수적으로 기록하고, 민감 데이터에 대한 '조회'도 정책에 따라 기록하는 `AuditService`를 구현합니다.
    -   다른 서비스 계층에서 `AuditService`를 호출하여 로그를 기록하고, 로그를 조회할 수 있는 API를 구현합니다.

### 2.2. 펌웨어 (`Firmware`) 관리 도메인 완성
-   **목표:** 펌웨어 버전의 전체 수명 주기(등록, 관리, 배포)를 관리하는 백엔드를 구축합니다.
-   **세부 고려사항:**
    -   `server2`에 이미 존재하는 `FirmwareUpdate` 모델과 `Device` 모델의 관계를 기반으로 합니다.
    -   `Firmware`와 `HardwareBlueprint` 간의 호환성 관계를 표현하는 모델/로직을 보강할 필요가 있을 수 있습니다.
    -   펌웨어 메타데이터를 관리(등록, 수정, 조회, 삭제)하고, 기기가 펌웨어 파일을 다운로드할 수 있는 전체 API를 구현합니다.

**💡 OTA 배포 아키텍처 (권장 Best Practice)**

가장 안정적이고 효율적인 OTA 배포 방법은 클라우드 기반 스토리지와 CDN을 활용하는 것입니다.

**1. 배포 파이프라인 (The Process)**
- **빌드 및 저장:** 개발자가 펌웨어 코드를 작성하고 빌드합니다.
- **업로드:** 완성된 펌웨어 바이너리 파일은 Amazon S3, Google Cloud Storage, 또는 Azure Blob Storage와 같은 클라우드 객체 스토리지에 업로드됩니다.
- **메타데이터 저장:** 펌웨어의 버전, 체크섬, 저장 경로(URL) 등의 정보는 **FastAPI 서버가 관리하는 데이터베이스(DB)**에 저장됩니다. (이것이 새로 생성할 `Firmware` 모델의 역할입니다.)
- **CDN 통합:** 객체 스토리지의 파일은 CloudFront(AWS), Cloud CDN(GCP) 등 CDN을 통해 전 세계에 캐싱됩니다.
- **장치 다운로드:** 장치가 서버에게 업데이트 요청을 하면, 서버는 DB에서 조회한 CDN URL을 장치에 전달하고, 장치는 CDN에서 파일을 빠르게 다운로드합니다.

**2. GitHub의 적절한 역할**
GitHub는 소스 코드 관리 역할만 담당하는 것이 이상적입니다.
- 개발 및 리뷰가 완료된 소스 코드는 GitHub에 저장됩니다.
- CI/CD(지속적 통합/배포) 파이프라인이 GitHub에서 소스를 가져와 펌웨어 바이너리를 생성하고, 이 바이너리만 객체 스토리지로 보냅니다.
- 요약하자면, GitHub는 펌웨어의 '제조 공장' 역할, 클라우드 스토리지는 펌웨어의 '물류 창고' 및 CDN은 '고속 배달 시스템' 역할을 합니다.

**3. 체크섬 (Checksum)의 중요성**

체크섬은 데이터의 무결성 및 보안 검증을 위한 파일의 "지문"과 같은 값입니다. 펌웨어 배포에서는 다음과 같이 사용됩니다.

-   **역할:** 파일이나 데이터의 내용을 수학적 연산을 통해 고정된 길이의 짧은 문자열로 변환한 값. 원본 파일의 내용이 단 한 비트라도 바뀌면 이 값은 완전히 달라집니다.
-   **필요성:**
    -   **데이터 무결성 검증:** 다운로드한 펌웨어 파일이 전송 과정에서 손상되지 않고 원본과 동일한지 확인합니다.
    -   **보안 위협 감지:** 악의적인 공격자에 의해 파일이 변조되었는지 감지합니다.
-   **작동 방식:**
    1.  서버는 펌웨어 파일의 체크섬을 계산하여 DB에 저장합니다.
    2.  장치는 서버로부터 파일 URL과 체크섬을 전달받습니다.
    3.  장치는 펌웨어 파일을 다운로드한 후, 다운로드한 파일의 체크섬을 직접 계산합니다。
    4.  장치는 자신이 계산한 값과 서버가 제공한 값을 비교하여, 일치하면 업데이트를 진행하고, 다르면 중단하거나 재시도합니다.

**4. `Firmware` 모델 추가 설계 (필수)**

위 OTA 아키텍처를 지원하고 펌웨어 패키지 자체의 정보를 관리하기 위해, 다음과 같은 `Firmware` 모델을 신규로 생성해야 합니다.

-   **위치:** `server2/app/models/objects/firmware.py` (예상)
-   **필드 예시:**
    -   `id` (PK)
    -   `version` (String, 예: "1.2.3")
    -   `description` (Text, 릴리즈 노트 등)
    -   `cdn_url` (String, 펌웨어 바이너리 다운로드 주소)
    -   `file_hash` (String, 체크섬 값, 예: SHA256)
    -   `hardware_blueprint_id` (FK to `HardwareBlueprint`, 이 펌웨어가 호환되는 하드웨어 모델)
    -   `uploaded_by_user_id` (FK to `User`, 이 펌웨어를 등록한 사용자)
    -   `organization_id` (FK to `Organization`, Null 허용, 특정 조직 전용 펌웨어인 경우)
    -   `release_channel_id` (FK to `ReleaseChannel` - 추천, 'stable', 'beta' 등)
    -   `created_at`, `updated_at` (TimestampMixin 상속)

### 2.3. 사용자 등록 승인 (`Registration Requests`) 워크플로우 완성
-   **목표:** 관리자가 특정 사용자의 가입 요청을 승인 또는 거절하는 관리 기능을 구현합니다.
-   **세부 고려사항:**
    -   `server2`에 이미 존재하는 `RegistrationRequest` 모델을 기반으로 합니다.
    -   관리자가 요청 목록을 보고, 각 요청을 승인/거절할 수 있는 API를 구현합니다. 승인 시 실제 사용자 계정이 생성되는 로직을 `AccountService`와 연동하여 구현합니다.

### 2.4. 구성 요소 (`Components`) 도메인 완성
-   **목표:** 기기에 부착되는 구성 요소(하드웨어 모듈 등)를 관리하는 기능을 완전히 구현합니다.
-   **세부 고려사항:**
    -   `server2`에 이미 존재하는 `SupportedComponent` 및 `DeviceComponentInstance` 모델을 기반으로 합니다.
    -   구성 요소의 유효성 검사 등 비즈니스 로직을 처리할 `ComponentService` 계층을 구현합니다.
    -   관리자 및 사용자를 위한 전체 API를 구현합니다.

### 2.5. 하드웨어 핀 구성 (`Hardware`) 관리 기능 완성
-   **목표:** 다양한 하드웨어 청사진(버전)에 대한 핀(Pin) 배치를 정의하고 관리하는 기능을 구현합니다.
-   **세부 고려사항:**
    -   `server2`에 이미 존재하는 `HardwareBlueprint` 및 `BlueprintPinMapping` 모델을 기반으로 합니다.
    -   핀 배치 정보의 유효성 검사 등 비즈니스 로직을 처리할 `HardwareService` 계층을 구현합니다.
    -   관리자가 핀 구성을 관리할 수 있는 API 엔드포인트를 구현합니다。

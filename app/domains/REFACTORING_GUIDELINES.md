# 도메인 리팩토링 가이드라인

이 문서는 애플리케이션 내 모든 도메인을 리팩토링하기 위한 원칙과 목표 아키텍처를 설명합니다. 일관되고 유지보수 가능하며 확장성 있는 코드베이스를 만드는 것이 목표입니다. 향후 모든 도메인 개발 및 리팩토링은 이 가이드라인을 따라야 합니다.

## 1. 목표 아키텍처 (4계층)

각 도메인은 `devices` 도메인에서 확립된 패턴에 따라 다음 네 가지 계층으로 구성되어야 합니다:

1.  **엔드포인트 (Endpoints):**
    *   **로직 파일 (`endpoints_*.py`):** 실제 `@router.get`, `@router.post` 등의 API 엔드포인트 로직을 포함합니다. 서비스나 의존성을 호출하는 역할을 합니다.
    *   **연결 파일 (`endpoints.py`):** 도메인 내의 모든 로직 라우터들을 `include_router`를 사용하여 하나로 묶고, 상위 애플리케이션 라우터에 연결될 단일 `router` 객체를 외부에 노출합니다.

2.  **의존성 (`dependencies.py`):**
    *   주로 리소스가 경로 파라미터(예: `/items/{item_id}`)로 식별되는 `read`, `update`, `delete` 작업에 대한 권한 부여 및 객체 검색에 사용됩니다.
    *   함수는 재사용 가능해야 하며, 존재 여부(`404` 발생) 및 권한(`403` 발생)을 확인해야 합니다.

3.  **서비스 (`services.py`):**
    *   핵심 비즈니스 로직을 포함합니다.
    *   CRUD 계층 호출을 조율합니다.
    *   특히 요청 본문에 따라 달라지는 `create` 작업과 같은 복잡한 권한 확인을 처리합니다.
    *   비즈니스 규칙(예: "클레임된 장치는 비활성화할 수 없습니다")을 구현합니다.

4.  **CRUD (`crud.py`):**
    *   순수한 데이터 접근 로직(생성, 읽기, 업데이트, 삭제)을 포함합니다.
    *   SQLAlchemy 모델을 통해 데이터베이스와 직접 상호 작용합니다.
    *   비즈니스 로직이나 권한 확인을 포함해서는 안 됩니다.
    *   모든 검색 메소드(`get`, `get_multi` 등)는 소프트 삭제를 존중하기 위해 기본적으로 `is_active = True` 필터 조건을 적용해야 합니다.

## 2. 핵심 원칙

모든 리팩토링은 다음 핵심 소프트웨어 엔지니어링 원칙을 따라야 합니다:

*   **단일 책임 원칙 (SRP - Single Responsibility Principle):** 각 모듈, 클래스 및 함수는 변경될 단 하나의 이유만 가져야 합니다.
    *   *예:* `CRUD` 계층은 데이터베이스 작업만 처리하고, `Service` 계층은 비즈니스 규칙을 처리합니다.

*   **최소 권한 원칙 (Principle of Least Privilege):** 권한 확인은 특정적이어야 하며, 작업에 필요한 것 이상의 접근 권한을 부여해서는 안 됩니다.
    *   *예:* 장치를 `읽을` 수 있는 사용자는 명시적으로 `device:update` 권한이 부여되지 않는 한 자동으로 `업데이트`할 수 없어야 합니다.

*   **중복 제거 (DRY - Don't Repeat Yourself):** 코드 중복을 피하십시오.
    *   *예:* `update` 및 `delete` 의존성은 초기 존재 및 읽기 권한 확인을 위해 `read` 의존성을 재사용해야 합니다.

*   **하드코딩 제거 (No Hardcoding):** 매직 스트링이나 고정된 값을 피하십시오. 적절한 경우 Enum, 상수 또는 설정 파일을 사용하십시오.
    *   *예:* `"device:create"`와 같은 권한 이름은 가능하면 중앙에서 관리되어야 합니다.

*   **모듈화 및 파일 구조 (Modularization & File Structure):** 각 도메인은 다음과 같은 디렉토리 구조를 따라야 합니다.
    ```
    /domain_name
    |-- endpoints.py          # 모든 라우터를 통합하여 외부에 노출
    |
    |-- api/                  # 엔드포인트 로직 파일들
    |   |-- __init__.py
    |   `-- endpoints_*.py
    |
    |-- schemas/              # 스키마 파일들
    |   |-- __init__.py
    |   `-- *.py
    |
    |-- services/             # 서비스(비즈니스 로직) 파일들
    |   |-- __init__.py
    |   `-- *.py
    |
    |-- crud/                 # CRUD(데이터 접근) 파일들
    |   |-- __init__.py
    |   `-- *.py
    |
    `-- dependencies/         # 의존성 주입 파일들
        |-- __init__.py
        `-- *.py
    ```
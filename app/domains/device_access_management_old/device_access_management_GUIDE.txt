# 가이드: `device_access_management` 전문가 서비스

이 문서는 'device_access_management' 전문가 서비스의 상세 구현 가이드입니다.

## 1. 목적 및 책임 (Purpose & Responsibility)

- 이 서비스는 **어떤 사용자가 어떤 장치에 대해 어떤 권한(소유자, 뷰어 등)을 갖는지**에 대한 관계(Link)를 관리하고 확인하는 책임을 가집니다.
- '역할(Role)' 기반의 시스템/조직 권한이 아닌, '개별 자산(Asset)' 레벨의 접근 제어를 담당합니다.
- 순수한 관계(Link) 설정 및 확인 로직만 포함하며, 다른 도메인의 비즈니스 로직을 포함해서는 안 됩니다.

## 2. 디렉토리 구조 (Directory Structure)

```
server2/app/domains/services/device_access_management/
├── __init__.py
├── crud/
│   ├── __init__.py
│   └── user_device_link_crud.py
├── schemas/
│   ├── __init__.py
│   └── user_device.py
└── services/
    ├── __init__.py
    └── device_access_management_service.py
```

## 3. 구현 상세 (Implementation Details)

### 3.1. `schemas/user_device.py`

- `devices_old/schemas/user_device.py` 파일을 이곳으로 옮깁니다.
- 내용은 `user_id`, `device_id`, `role` (e.g., 'owner', 'viewer'), `nickname` 등을 포함합니다.

### 3.2. `crud/user_device_link_crud.py`

- `UserDevice` 모델에 대한 `CRUDBase`를 상속받는 `CRUDUserDeviceLink` 클래스를 생성합니다.
- 이 CRUD는 `UserDevice` 관계 테이블에 대한 기본적인 DB 작업을 정의합니다.

### 3.3. `services/device_access_management_service.py`

- **`DeviceAccessManagementService` 클래스:**
    - 이 서비스는 사용자-장치 간의 연결(link)을 생성, 조회, 삭제하고, 특정 사용자가 장치의 소유자인지 확인하는 로직을 포함합니다.

```python
# server2/app/domains/services/device_access_management/services/device_access_management_service.py

from sqlalchemy.orm import Session
from typing import List, Optional

from ..crud.user_device_link_crud import user_device_link_crud
from ..schemas.user_device import UserDeviceCreate
from app.models.relationships.user_device import UserDevice
from app.models.objects.user import User as DBUser # For auditing
from app.domains.inter_domain.audit.providers import audit_providers

class DeviceAccessManagementService:
    def link_device_to_user(self, db: Session, *, link_in: UserDeviceCreate, actor_user: DBUser) -> UserDevice:
        """
        Links a user to a device with a specific role (e.g., owner, viewer).
        """
        # TODO: Add logic to prevent duplicate links.
        db_link = user_device_link_crud.create(db, obj_in=link_in)

        audit_providers.log(
            db=db,
            event_type="USER_DEVICE_LINK_CREATED",
            description=f"User {link_in.user_id} was linked to device {link_in.device_id} with role '{link_in.role}'.",
            actor_user=actor_user,
            details={"user_id": link_in.user_id, "device_id": link_in.device_id, "role": link_in.role}
        )
        return db_link

    def get_links_for_device(self, db: Session, *, device_id: int) -> List[UserDevice]:
        """
        Gets all user links for a specific device.
        """
        return user_device_link_crud.get_multi_by_device(db, device_id=device_id) # Assumes this method exists in CRUD

    def remove_link(self, db: Session, *, user_id: int, device_id: int, actor_user: DBUser) -> Optional[UserDevice]:
        """
        Removes a link between a user and a device.
        """
        # TODO: Get link by user_id and device_id, then remove.
        db_link = user_device_link_crud.remove_by_user_and_device(db, user_id=user_id, device_id=device_id) # Assumes this method exists in CRUD
        
        if db_link:
            audit_providers.log(
                db=db,
                event_type="USER_DEVICE_LINK_REMOVED",
                description=f"Link between user {user_id} and device {device_id} was removed.",
                actor_user=actor_user,
                details={"user_id": user_id, "device_id": device_id}
            )
        return db_link

    def is_user_owner_of_device(self, db: Session, *, user_id: int, device_id: int) -> bool:
        """
        Checks if a user is an 'owner' of a specific device.
        (Moved from user_authorization_service)
        """
        link = user_device_link_crud.get_by_user_and_device_with_role(db, user_id=user_id, device_id=device_id, role='owner') # Assumes this method exists in CRUD
        return link is not None

device_access_management_service = DeviceAccessManagementService()
```

## 4. `inter_domain` 프로바이더

- **경로:** `server2/app/domains/inter_domain/device_access_management/providers.py`
- **목적:** 위에서 정의한 `DeviceAccessManagementService`의 함수들을 다른 도메인에 안전하게 노출합니다.

```python
# server2/app/domains/inter_domain/device_access_management/providers.py

from sqlalchemy.orm import Session
from typing import List, Optional

from app.domains.services.device_access_management.services.device_access_management_service import device_access_management_service
from app.domains.services.device_access_management.schemas.user_device import UserDeviceCreate
from app.models.relationships.user_device import UserDevice
from app.models.objects.user import User as DBUser

class DeviceAccessManagementProviders:
    def link_device_to_user(self, db: Session, *, link_in: UserDeviceCreate, actor_user: DBUser) -> UserDevice:
        return device_access_management_service.link_device_to_user(db, link_in=link_in, actor_user=actor_user)

    def get_links_for_device(self, db: Session, *, device_id: int) -> List[UserDevice]:
        return device_access_management_service.get_links_for_device(db, device_id=device_id)

    def remove_link(self, db: Session, *, user_id: int, device_id: int, actor_user: DBUser) -> Optional[UserDevice]:
        return device_access_management_service.remove_link(db, user_id=user_id, device_id=device_id, actor_user=actor_user)

    def is_user_owner_of_device(self, db: Session, *, user_id: int, device_id: int) -> bool:
        return device_access_management_service.is_user_owner_of_device(db, user_id=user_id, device_id=device_id)

device_access_management_providers = DeviceAccessManagementProviders()
```

# 가이드: `device_api` 애플리케이션 서비스

이 문서는 'device_api' 애플리케이션 서비스(오케스트레이터)의 상세 구현 가이드입니다.

## 1. 목적 및 책임 (Purpose & Responsibility)

- 이 서비스는 **장치와 관련된 모든 외부 공개 API 엔드포인트를 정의하고 노출**하는 책임을 가집니다.
- 자체적으로 비즈니스 로직을 거의 가지지 않으며, `inter_domain` 프로바이더나 다른 애플리케이션 서비스(예: `device_provisioning`)를 호출하여 외부 요청을 내부 워크플로우에 연결합니다.

## 2. 디렉토리 구조 (Directory Structure)

```
server2/app/domains/application/device_api/
├── __init__.py
└── api/
    ├── __init__.py
    └── endpoints.py
```

## 3. 구현 상세 (Implementation Details)

### 3.1. `api/endpoints.py`

- 이 파일은 `devices_old/api/endpoints_device_management.py`의 내용을 가져와 리팩토링합니다.
- 모든 서비스 호출은 `inter_domain` 프로바이더를 통해 이루어져야 합니다.

```python
# server2/app/domains/application/device_api/api/endpoints.py

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from typing import List

# Dependencies
from app.dependencies import get_db, get_current_user

# Models
from app.models.objects.user import User as DBUser
from app.models.objects.device import Device

# Schemas from other domains
from app.domains.application.device_provisioning.schemas.provisioning import DeviceClaimRequest
from app.domains.services.device_core_management.schemas.device import DeviceUpdate

# Inter-domain providers / Application service providers
from app.domains.inter_domain.device_provisioning.providers import device_provisioning_providers # Assuming this provider is created
from app.domains.inter_domain.device_access_management.providers import device_access_management_providers
from app.domains.inter_domain.device_core_management.providers import device_core_management_providers

router = APIRouter()

@router.post("/provision", response_model=Device)
def provision_device(
    *,
    db: Session = Depends(get_db),
    claim_in: DeviceClaimRequest,
    current_user: DBUser = Depends(get_current_user),
):
    """
    Provision a new device. This is a high-level workflow.
    """
    return device_provisioning_providers.provision_new_device(db=db, claim_in=claim_in, request_user=current_user)

@router.get("/{device_id}", response_model=Device)
def read_device(
    *,
    db: Session = Depends(get_db),
    device_id: int,
    current_user: DBUser = Depends(get_current_user),
):
    """
    Get a specific device by ID. Access is checked within the service.
    """
    # This now needs a "smart" service that checks access
    # We will need a new provider from a service that encapsulates the logic from devices_old/dependencies.
    # For now, let's assume `device_access_management_providers` will have this.
    return device_access_management_providers.get_device_if_user_has_read_access(db=db, device_id=device_id, user=current_user)


@router.put("/{device_id}", response_model=Device)
def update_device(
    *,
    db: Session = Depends(get_db),
    device_id: int,
    device_in: DeviceUpdate,
    current_user: DBUser = Depends(get_current_user),
):
    """
    Update a device. Access is checked within the service.
    """
    # This also needs a "smart" service
    device = device_access_management_providers.get_device_if_user_has_update_access(db=db, device_id=device_id, user=current_user)
    return device_core_management_providers.update_device(db=db, device_id=device.id, obj_in=device_in)

# ... other endpoints ...
```

## 4. 메인 라우터에 통합

- **`server2/app/api/v1/api.py`** 파일에 이 `device_api` 라우터를 포함시켜야 합니다.

```python
# In server2/app/api/v1/api.py

# ... other imports
from app.domains.application.device_api.api import endpoints as device_api_router

# ...

api_router.include_router(device_api_router.router, prefix="/devices", tags=["devices"])
```

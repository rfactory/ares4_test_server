node.name = emqx@127.0.0.1
node.cookie = ares4_super_secret_cookie
node.data_dir = "/opt/emqx/data"

listeners.ssl.default {
  bind = "0.0.0.0:8883"
  max_connections = 1024
  ssl_options {
    keyfile = "/opt/emqx/etc/certs/emqx.key"
    certfile = "/opt/emqx/etc/certs/emqx.crt"
    cacertfile = "/opt/emqx/etc/certs/ca.crt"
    verify = verify_peer
    fail_if_no_peer_cert = true
  }
}

# --- HTTP Authentication Settings (EMQX 6.0 Enterprise Syntax) ---
authentication = {
  mechanism = password_based
  backend = http
  method = post
  url = "http://fastapi_app2:8000/api/v1/mqtt/auth"
  headers {
    "Content-Type" = "application/json"
  }
  body {
    clientid = "${clientid}"
    username = "${username}"
    password = "${password}"
  }
  connect_timeout = "30s"  # 증가: 연결 지연 허용
  request_timeout = "30s"  # 증가: 요청 지연 허용
  pool_size = 16  # 증가: 연결 풀 확대
}

authorization = {
  sources = [
    {
      type = http
      method = post
      url = "http://fastapi_app2:8000/api/v1/mqtt/acl"
      headers {
        "Content-Type" = "application/json"
      }
      body {
        clientid = "${clientid}"
        username = "${username}"
        access = "${access}"
        topic = "${topic}"
      }
      connect_timeout = "30s"
      request_timeout = "30s"
      pool_size = 16
    }
  ]
}